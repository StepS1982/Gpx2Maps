<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GPX2MAPS Web-APP</title>
  <meta name="description" content="Software per gestire al 100% itinerati con Google Maps in modalità navigabile" />
  <style>
    :root{
      --accent:#e11d48; --fg:#0f172a; --muted:#475569; --bg:#f8fafc;
      --card:#fff; --border:#e2e8f0; --btn:#0ea5e9; --btn2:#22c55e; --btnDanger:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;color:var(--fg);background:var(--bg)}
    header{padding:20px 16px 8px;background:var(--card);border-bottom:1px solid var(--border)}
    .hero{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:16px}
    .hero img{width:44px;height:44px;border-radius:10px}
    .title{font-weight:800;font-size:24px;line-height:1.1}
    .subtitle{color:var(--accent);font-weight:700}
    .cta{margin:12px 0 0;display:flex;justify-content:center;gap:10px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid transparent;background:var(--btn);color:#fff;padding:10px 14px;border-radius:999px;cursor:pointer;font-weight:700}
    .btn.secondary{background:var(--btn2)} .btn.ghost{background:#fff;color:var(--fg);border-color:var(--border)} .btn.small{padding:6px 10px;font-weight:600} .btn.danger{background:var(--btnDanger)}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .note{margin:14px 0 6px;color:var(--muted);font-size:14px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;border-bottom:1px solid var(--border);margin-top:12px}
    .tab{padding:10px 12px;cursor:pointer;border:1px solid var(--border);border-bottom:none;border-radius:10px 10px 0 0;background:#f1f5f9;font-weight:700}
    .tab.active{background:#fff;color:#0ea5e9}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .card .hd{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:800}
    .card .bd{padding:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:900px){.grid-2{grid-template-columns:1.4fr 1fr}}
    textarea{width:100%;min-height:180px;resize:vertical;padding:12px;border-radius:10px;border:1px solid var(--border);font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;word-break:break-all}
    dialog{border:none;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.2);width:min(560px,92vw)} dialog::backdrop{background:rgba(0,0,0,.35)}
    #toastsCenter{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:60}
    .toast.center{padding:12px 16px;font-size:15px;background:rgba(17,24,39,.95);color:#fff;border-radius:10px;box-shadow:0 6px 16px rgba(0,0,0,.28);animation:fadePop .28s ease-out}
    @keyframes fadePop{from{opacity:0;transform:translateY(6px) scale(.98)}to{opacity:1;transform:translateY(0) scale(1)}}
    .out-item+.out-item{margin-top:8px}
    footer{margin:36px auto 24px;max-width:1100px;color:var(--muted);font-size:13px;padding:0 16px}
  </style>
</head>
<body>
  <header>
    <div class="hero">
      <img src="/gpx2maps_icon_1024.png" alt="Logo GPX2MAPS" />
      <div>
        <div class="title">GPX2MAPS Web-APP</div>
        <div class="subtitle">by Pieghello</div>
      </div>
    </div>
    <div class="cta">
      <a id="donateBtn" class="btn" href="#" target="_blank" rel="noopener">Dona</a>
      <a id="amazonBtn" class="btn secondary" href="#" target="_blank" rel="noopener">Offerte e Coupon Amazon</a>
    </div>
  </header>

  <div class="container">
    <div class="note">Software per gestire al 100% itinerati con Google Maps in modalità navigabile</div>

    <div class="tabs" role="tablist">
      <button class="tab active" role="tab" aria-selected="true"  data-tab="merge">Fusione Link</button>
      <button class="tab"         role="tab" aria-selected="false" data-tab="maps2gpx">2) Google Maps → GPX</button>
      <button class="tab"         role="tab" aria-selected="false" data-tab="gpx2maps">3) GPX → Google Maps</button>
      <button class="tab"         role="tab" aria-selected="false" data-tab="sanitize">4) Sanitizza GPX</button>
      <button class="tab"         role="tab" aria-selected="false" data-tab="meteo">5) Meteo + Info percorso</button>
    </div>

    <!-- TAB 1 -->
    <section id="tab-merge" class="card">
      <div class="hd">Fusione, ottimizzazione e split dei link Google Maps</div>
      <div class="bd grid grid-2">
        <p class="note" style="grid-column:1/-1;">
          Il limite su Google Maps è di 10 punti, con questo strumento possiamo arrivare a 25 in modalità navigabile che è il vero limite nascosto di Google. Se si dovessero superare i 25 punti, verrebbe proposto o di ottimizzare a 25, mantenendo fissi il primo e l'ultimo punto, oppure si possono generare tanti link da 25 punti fino al completamento dell'intero itinerario
        </p>
        <div>
          <label for="linksInput" style="font-weight:800;">Incolla i link (uno per riga)</label>
          <textarea id="linksInput" placeholder="Incolla link tipo https://www.google.*/maps/dir/... (uno per riga). Accetta anche maps.app.goo.gl"></textarea>
          <div class="row" style="margin-top:12px;">
            <button id="btnMerge" class="btn">Analizza e Unisci</button>
            <button id="btnClear" class="btn ghost">Pulisci</button>
          </div>
        </div>
        <div>
          <div class="out card">
            <div class="hd">Risultati</div>
            <div class="bd">
              <div id="stats" class="note">Nessun risultato ancora.</div>
              <div id="output"></div>
              <div class="row" style="margin-top:10px;">
                <button id="btnDownloadAll" class="btn small" style="display:none;">Scarica .txt</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- TAB 2 -->
    <section id="tab-maps2gpx" class="card" hidden>
      <div class="hd">2) Google Maps → GPX</div>
      <div class="bd grid grid-2">
        <div>
          <label for="maps2gpxInput" style="font-weight:800;">Incolla un link Google Maps (itinerario) o una lista di indirizzi/coordinate</label>
          <textarea id="maps2gpxInput" placeholder="Esempi:
- https://www.google.com/maps/dir/Punto+A/Punto+B/...
- Indirizzi o lat,lon (uno per riga)
- Puoi incollare link con // iniziale: qui viene ignorato (come nello script)"></textarea>
          <div class="row" style="margin-top:12px;">
            <button id="btnGenGPX" class="btn">Genera GPX</button>
            <button id="btnClear2" class="btn ghost">Pulisci</button>
          </div>
        </div>
        <div>
          <div class="out card">
            <div class="hd">Risultati</div>
            <div class="bd">
              <div id="stats2" class="note">Nessun file generato.</div>
              <details id="previewWrapRte" style="margin-top:8px;" hidden>
                <summary>Anteprima GPX Rotta (WPT + RTE)</summary>
                <pre id="gpxPreviewRte" class="mono" style="max-height:220px;overflow:auto;white-space:pre;background:#f8fafc;border:1px solid var(--border);padding:10px;border-radius:10px;"></pre>
              </details>
              <details id="previewWrapTrk" style="margin-top:8px;" hidden>
                <summary>Anteprima GPX Traccia (WPT + TRK)</summary>
                <pre id="gpxPreviewTrk" class="mono" style="max-height:220px;overflow:auto;white-space:pre;background:#f8fafc;border:1px solid var(--border);padding:10px;border-radius:10px;"></pre>
              </details>
              <div class="row" id="dlRow" style="margin-top:10px;display:none;">
                <button id="btnDownloadRTE" class="btn small">Scarica GPX Rotta</button>
                <button id="btnDownloadTRK" class="btn small">Scarica GPX Traccia</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Placeholder altri tab -->
    <section id="tab-gpx2maps" class="card" hidden><div class="hd">3) GPX → Google Maps</div><div class="bd">In arrivo.</div></section>
    <section id="tab-sanitize" class="card" hidden><div class="hd">4) Sanitizza GPX</div><div class="bd">In arrivo.</div></section>
    <section id="tab-meteo" class="card" hidden><div class="hd">5) Meteo + Info percorso</div><div class="bd">In arrivo.</div></section>
  </div>

  <footer>
    L'applicazione è stata realizzata a scopo gratuito per la comunità. Se si vuole fare un'opera di gentilezza nei confronti dello sviluppatore che ci ha perso del tempo per realizzarla, si prega di effettuare una donazione con il pulsante ‘Dona’ in alto. Approfitta anche del link diretto alla pagina nascosta di Amazon con tutte le offerte e coupon, che è accessibile con il pulsante che si trova sempre in alto.
  </footer>

  <!-- Modals -->
  <dialog id="confirmDialog">
    <form method="dialog" style="padding:18px 18px 8px;">
      <h3 style="margin:0 0 6px;font-weight:900;">Confermi l'operazione?</h3>
      <p id="confirmText" style="margin:0 0 14px;color:var(--muted);"></p>
      <div class="row" style="justify-content:flex-end;">
        <button class="btn ghost" value="cancel">Annulla</button>
        <button class="btn" value="ok">Conferma</button>
      </div>
    </form>
  </dialog>

  <dialog id="strategyDialog">
    <form method="dialog" style="padding:18px 18px 8px;">
      <h3 style="margin:0 0 6px;font-weight:900;">Troppi punti per un singolo link</h3>
      <p style="margin:0 0 10px;color:var(--muted);">Hai superato il limite di 25 (incluso il primo punto con la tua posizione GPS). Scegli una strategia:</p>
      <div class="row" style="flex-direction:column;align-items:stretch;gap:10px;">
        <button id="btnStrategyOptimize" class="btn" value="opt">1) Ottimizza a 25 (mantieni testa/coda, campiona gli intermedi)</button>
        <button id="btnStrategySplit" class="btn secondary" value="split">2) Dividi in più link (max 25 punti; solo il primo ha “//”)</button>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:10px;">
        <button class="btn ghost" value="cancel">Chiudi</button>
      </div>
    </form>
  </dialog>

  <div id="toastsCenter" aria-live="polite" aria-atomic="true"></div>

  <script>
    const CONFIG = {
      workerBase: "https://gpx2maps-worker.stefano-vitro.workers.dev",
      paypalDonateUrl: "https://www.paypal.com/donate?business=stefano.vitro%40gmail.com&no_recurring=0&item_name=Supporto+sviluppo+GPX2MAPS&currency_code=EUR",
      amazonAffiliateUrl: "https://amzn.to/41o2XjA"
    };
    document.getElementById('donateBtn').href=CONFIG.paypalDonateUrl;
    document.getElementById('amazonBtn').href=CONFIG.amazonAffiliateUrl;

    /* Tabs */
    const tabs=[].slice.call(document.querySelectorAll('.tab'));
    tabs.forEach(function(btn){
      btn.addEventListener('click',function(){
        tabs.forEach(function(b){ b.classList.remove('active'); b.setAttribute('aria-selected','false'); });
        btn.classList.add('active'); btn.setAttribute('aria-selected','true');
        const id=btn.dataset.tab;
        ['merge','maps2gpx','gpx2maps','sanitize','meteo'].forEach(function(k){
          const s=document.getElementById('tab-'+k);
          if(s) s.hidden = k!==id && !(k==='merge'&&id===undefined);
        });
      });
    });

    /* Toast center 3s */
    function toastCenter(msg){
      const box=document.getElementById('toastsCenter');
      box.innerHTML='';
      const t=document.createElement('div');
      t.className='toast center';
      t.textContent=msg;
      box.appendChild(t);
      setTimeout(function(){ if(t.parentNode) t.parentNode.removeChild(t); },3000);
    }
    function toast(msg){ toastCenter(msg); }

    // Confirm
    async function confirmAction(text){
      const dlg=document.getElementById('confirmDialog');
      document.getElementById('confirmText').textContent=text||'';
      dlg.showModal();
      const val = await new Promise(function(resolve){
        const handler=function(){ dlg.removeEventListener('close',handler); resolve(dlg.returnValue); };
        dlg.addEventListener('close',handler);
      });
      return val==='ok';
    }

    async function getJSON(u){
      const r=await fetch(u,{headers:{'Accept':'application/json'}});
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    /* Helpers */
    function stripAtTail(s){ return s.replace(/\/@.*$/,'').replace(/\/data=.*$/,''); }

    // Round "midpoint to even" su numero
    function roundHalfEvenToFixed(n, d){
      d = (typeof d==='number')?d:6;
      const scale = Math.pow(10, d);
      let x = Number(n) * scale;
      let sign = 1;
      if (x < 0) { sign = -1; x = -x; }
      let base = Math.floor(x);
      let frac = x - base;
      const EPS = 1e-12;
      let up;
      if (frac > 0.5 + EPS) up = true;
      else if (frac < 0.5 - EPS) up = false;
      else up = (Math.abs(base) % 2 === 1);
      let units = base + (up ? 1 : 0);
      let whole = Math.floor(units / scale);
      let fracUnits = units - whole * scale;
      const fracStr = String(fracUnits).padStart(d, '0');
      return (sign < 0 ? '-' : '') + String(whole) + (d>0?('.' + fracStr):'');
    }
    var fmt6s = function(x){ return roundHalfEvenToFixed(x, 6); };

    function decodeTok(p){ try{return decodeURIComponent(p).replace(/\+/g,' ').trim();}catch(e){return p.replace(/\+/g,' ').trim();} }
    function xmlEscape(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;'); }
    function fileNameSafe(s){ return (s||'').replace(/[\\\/:*?"<>|]/g,'').replace(/\s+/g,' ').trim(); }
    function nowStamp(){ var d=new Date(),p=function(n){return String(n).padStart(2,'0')}; return d.getFullYear()+p(d.getMonth()+1)+p(d.getDate())+'_'+p(d.getHours())+p(d.getMinutes())+p(d.getSeconds()); }
    function timeHHMMSS(){ var d=new Date(),p=function(n){return String(n).padStart(2,'0')}; return p(d.getHours())+':'+p(d.getMinutes())+':'+p(d.getSeconds()); }
    function joinLF(a){ return a.join('\n'); }
    function ensureFinalLF(s){ return /\n$/.test(s) ? s : (s + '\n'); }

    /* TAB 1 (invariato rispetto al tuo baseline) */
    function extractDirSegment(s){
      var m=stripAtTail(s.trim()).match(/^https?:\/\/[^/]*google\.[^/]+\/maps\/dir\/(.+)$/i);
      if(!m) return null;
      return m[1].replace(/^\/+/,'').replace(/\/+$/,'');
    }
    async function resolveIfShort(url){
      try{
        var h=(new URL(url)).host;
        if(!/(^|\.)maps\.app\.goo\.gl$/i.test(h)&&!/(^|\.)goo\.gl$/i.test(h)&&!/(^|\.)g\.co$/i.test(h)) return url;
        var j=await getJSON(CONFIG.workerBase+'/resolve?url='+encodeURIComponent(url));
        var finalUrl=j && j.finalUrl ? j.finalUrl : null;
        return finalUrl||url;
      }catch(e){ return url; }
    }
    function buildGoogleDirURL(parts){ return 'https://www.google.com/maps/dir/'+parts.join('/'); }
    function dedupeAdjacent(a){ var out=[], prev=null; for(var i=0;i<a.length;i++){ var x=a[i]; if(x!==prev) out.push(x); prev=x; } return out; }
    function evenSample(inner,need){
      if(need<=0)return[];
      if(inner.length<=need)return inner.slice();
      var out=[];
      for(var i=0;i<need;i++){ var idx=Math.round(i*(inner.length-1)/(need-1)); out.push(inner[idx]); }
      var res=[]; for(var k=0;k<out.length;k++){ var v=out[k]; if(res.length===0 || res[res.length-1]!==v) res.push(v); }
      while(res.length>need) res.pop();
      return res;
    }
    function optimizeTo25(all){
      if(all.length<=25) return all;
      var first=all[0], last=all[all.length-1];
      var mid=all.slice(1,all.length-1);
      var sampled=evenSample(mid,23);
      return [first].concat(sampled).concat([last]).slice(0,25);
    }
    function splitInBlocks(all){
      var MAX=25, blocks=[], rest=all.slice(), first=true;
      while(rest.length){
        var chunk=rest.slice(0,MAX);
        if(!first && chunk[0]==="") chunk.shift();
        blocks.push(chunk);
        rest=rest.slice(MAX);
        first=false;
      }
      return blocks;
    }
    function renderOutput(urls){
      var out=document.getElementById('output'),stats=document.getElementById('stats'); out.innerHTML='';
      if(!urls.length){ stats.textContent='Nessun risultato.'; document.getElementById('btnDownloadAll').style.display='none'; return; }
      var n=urls.length; stats.textContent=(n===1?'1 link generato':(n+' link generati'))+' · aggiornato alle '+timeHHMMSS();
      urls.forEach(function(u){
        var div=document.createElement('div'); div.className='out-item';
        div.innerHTML='<div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">'
            +'<div class="mono" style="flex:1 1 auto;">'+u+'</div>'
            +'<div class="row" style="flex:0 0 auto;">'
            +  '<button class="btn small ghost" data-copy>Copia</button>'
            +  '<button class="btn small" data-open>Apri</button>'
            +'</div>'
          +'</div>';
        div.querySelector('[data-copy]').addEventListener('click',async function(){ await navigator.clipboard.writeText(u); toast('URL copiato'); });
        div.querySelector('[data-open]').addEventListener('click',async function(){ var ok=await confirmAction('Aprire il link in una nuova scheda?'); if(ok) window.open(u,'_blank','noopener'); });
        out.appendChild(div);
      });
      document.getElementById('btnDownloadAll').style.display='';
      toastCenter('Risultati aggiornati ('+n+' link)');
    }
    function chooseStrategy(){
      const dlg=document.getElementById('strategyDialog');
      dlg.showModal();
      return new Promise(function(resolve){
        const handler=function(){
          dlg.removeEventListener('close',handler);
          const rv = dlg.returnValue==='opt'?'optimize' : (dlg.returnValue==='split'?'split':null);
          resolve(rv);
        };
        dlg.addEventListener('close',handler);
      });
    }
    document.getElementById('btnMerge').addEventListener('click', async function(){
      var lines=document.getElementById('linksInput').value.split('\n').map(function(s){return s.trim()}).filter(Boolean);
      if(!lines.length){toastCenter('Inserisci almeno un link');return}
      if(lines.length===1 && /https?:\/\/[^/]*google\.[^/]+\/maps\/dir\/\//i.test(lines[0])){toastCenter('Errore: almeno due link sono necessari per la fusione.');return}
      var resolved=[]; for(var i=0;i<lines.length;i++){ resolved.push(await resolveIfShort(lines[i])); }
      var clean=[]; for(i=0;i<resolved.length;i++){ var seg=extractDirSegment(resolved[i]); if(seg) clean.push(seg); }
      if(!clean.length){toastCenter('Nessun link valido "/maps/dir/..." rilevato');return}
      var all=[""]; for(i=0;i<clean.length;i++){ Array.prototype.push.apply(all, clean[i].split('/')); }
      all=dedupeAdjacent(all);
      if(all.length<=25){renderOutput([buildGoogleDirURL(all)]);return}
      var strategy=await chooseStrategy();
      if(!strategy){toastCenter('Operazione annullata');return}
      if(strategy==='optimize'){renderOutput([buildGoogleDirURL(optimizeTo25(all))]);}
      else{var blocks=splitInBlocks(all); renderOutput(blocks.map(function(b){return buildGoogleDirURL(b)}));}
    });
    document.getElementById('btnClear').addEventListener('click',function(){
      document.getElementById('linksInput').value='';
      document.getElementById('output').innerHTML='';
      document.getElementById('stats').textContent='Pulito.';
      document.getElementById('btnDownloadAll').style.display='none';
    });
    document.getElementById('btnDownloadAll').addEventListener('click',async function(){
      var items=[].slice.call(document.querySelectorAll('#output .out-item .mono')).map(function(x){return x.textContent;});
      if(!items.length) return;
      var ok=await confirmAction('Scaricare un file .txt con i link generati?'); if(!ok) return;
      var name=(items.length===1?('merge_1_'+nowStamp()+'.txt'):('merge_'+items.length+'_'+nowStamp()+'.txt'));
      var sep=items.length>1?'\n\n':'\n';
      var bytes=new TextEncoder().encode(items.join(sep));
      var url=URL.createObjectURL(new Blob([bytes],{type:'text/plain'}));
      var a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      toast('File scaricato');
    });

    /* TAB 2 */
    function extractDirSegmentKeepLeading(s){
      var m=stripAtTail(s.trim()).match(/^https?:\/\/[^/]*google\.[^/]+\/maps\/dir\/(.+)$/i);
      if(!m) return null;
      return m[1].replace(/\/+$/,'');
    }
    function isLatLonStr(s){ var m=s.trim().match(/^(-?\d+(?:\.\d+)?),\s*(-?\d+(?:\.\d+)?)$/); return m?{lat:m[1],lon:m[2]}:null; }
    async function geocodeTry(q){ try{ var r=await getJSON(CONFIG.workerBase+'/geocode?q='+encodeURIComponent(q)); if(Array.isArray(r)&&r.length) return r[0]; }catch(e){} return null; }
    async function geocodeFreeform(t){
      var ll=isLatLonStr(t); if(ll) return {lat:ll.lat,lon:ll.lon,label:String(ll.lat)+','+String(ll.lon)};
      var g=await geocodeTry(t); if(g) return {lat:String(g.lat),lon:String(g.lon),label:g.display_name||t};
      g=await geocodeTry(t+', Italia'); if(g) return {lat:String(g.lat),lon:String(g.lon),label:g.display_name||t};
      var head=t.split(',')[0].trim(); if(head&&head!==t){ g=await geocodeTry(head+', Italia'); if(g) return {lat:String(g.lat),lon:String(g.lon),label:g.display_name||head}; }
      return null;
    }
    async function reverseShortLabel(lat,lon){
      try{
        var r=await getJSON(CONFIG.workerBase+'/reverse?lat='+lat+'&lon='+lon);
        var a=r&&r.address?r.address:{};
        var city=a.city||a.town||a.village||a.hamlet||'';
        var prov=a.state_district||a.county||'';
        if(city) return prov?(city+' ('+prov+')'):city;
      }catch(e){}
      return 'Località';
    }

    function buildGPX_RTE_WPT(points, steps, title){
      var L=[]; L.push('<?xml version="1.0" encoding="UTF-8"?>'); L.push('<gpx version="1.1" creator="MAPS2GPX OSRM" xmlns="http://www.topografix.com/GPX/1/1">'); L.push('  <metadata><time>'+new Date().toISOString()+'</time></metadata>');
      for(var i=0;i<points.length;i++){
        var p=points[i],lat=fmt6s(Number(p.lat)),lon=fmt6s(Number(p.lon)),name='WP'+String(i+1).padStart(2,'0');
        var desc=p.label?xmlEscape(p.label):(lat+','+lon);
        L.push('  <wpt lat="'+lat+'" lon="'+lon+'"><name>'+name+'</name><desc>'+desc+'</desc></wpt>');
      }
      L.push('  <rte><name>'+xmlEscape(title)+'</name>');
      for(var j=0;j<steps.length;j++){
        var s=steps[j], lat2=fmt6s(Number(s.lat)), lon2=fmt6s(Number(s.lon)), lab=xmlEscape(s.type||'via');
        L.push('    <rtept lat="'+lat2+'" lon="'+lon2+'"><name>'+lab+'</name></rtept>');
      }
      L.push('  </rte>'); L.push('</gpx>');
      return ensureFinalLF(joinLF(L));
    }
    function buildGPX_TRK_WPT(points, trkCoords, title){
      var L=[]; L.push('<?xml version="1.0" encoding="UTF-8"?>'); L.push('<gpx version="1.1" creator="MAPS2GPX OSRM" xmlns="http://www.topografix.com/GPX/1/1">'); L.push('  <metadata><time>'+new Date().toISOString()+'</time></metadata>');
      for(var i=0;i<points.length;i++){
        var p=points[i],lat=fmt6s(Number(p.lat)),lon=fmt6s(Number(p.lon)),name='WP'+String(i+1).padStart(2,'0');
        var desc=p.label?xmlEscape(p.label):(lat+','+lon);
        L.push('  <wpt lat="'+lat+'" lon="'+lon+'"><name>'+name+'</name><desc>'+desc+'</desc></wpt>');
      }
      L.push('  <trk><name>'+xmlEscape(title)+'</name><trkseg>');
      for(var t=0;t<trkCoords.length;t++){
        var c=trkCoords[t], lon3=fmt6s(Number(c[0])), lat3=fmt6s(Number(c[1]));
        L.push('    <trkpt lat="'+lat3+'" lon="'+lon3+'" />');
      }
      L.push('  </trkseg></trk>'); L.push('</gpx>');
      return ensureFinalLF(joinLF(L));
    }

    var gpxRTE=null,gpxTRK=null,nameRTE='',nameTRK='';
    function resetMaps2GPXUI(){
      document.getElementById('stats2').textContent='Nessun file generato.';
      document.getElementById('gpxPreviewRte').textContent='';
      document.getElementById('gpxPreviewTrk').textContent='';
      document.getElementById('previewWrapRte').hidden=true;
      document.getElementById('previewWrapTrk').hidden=true;
      document.getElementById('dlRow').style.display='none';
      gpxRTE=gpxTRK=null; nameRTE=nameTRK='';
    }

    document.getElementById('btnGenGPX').addEventListener('click', async function(){
      resetMaps2GPXUI();
      var raw=document.getElementById('maps2gpxInput').value.split('\n').map(function(s){return s.trim()}).filter(Boolean);
      if(!raw.length){toastCenter('Inserisci almeno una riga');return}

      // Tokenize (salta //)
      var tokens=[];
      for(var i=0;i<raw.length;i++){
        var line=raw[i];
        if(/^https?:\/\//i.test(line)){
          var resolved=await resolveIfShort(line);
          var seg=extractDirSegmentKeepLeading(resolved);
          if(!seg){toastCenter('Link non valido: manca /maps/dir/');return;}
          var parts=seg.split('/'); parts=parts.filter(function(x){return x!==''}); parts=parts.map(decodeTok).filter(Boolean);
          Array.prototype.push.apply(tokens, parts);
        }else{
          if(line!=='//') tokens.push(line);
        }
      }

      // Geocoding con salta-errori
      var ordered=[], skipped=[];
      for(i=0;i<tokens.length;i++){
        document.getElementById('stats2').textContent='Geocoding '+(i+1)+'/'+tokens.length+'...';
        var g=await geocodeFreeform(tokens[i]);
        if(!g){ skipped.push(tokens[i]); continue; }
        // arrotonda come PS già qui
        g.lat = roundHalfEvenToFixed(Number(g.lat), 6);
        g.lon = roundHalfEvenToFixed(Number(g.lon), 6);
        ordered.push(g);
      }
      if(ordered.length<2){ document.getElementById('stats2').textContent='Errore: geocoding fallito (troppi pochi punti).'; return; }
      if(skipped.length){ toastCenter('Saltati '+skipped.length+' punto/i non geocodificati'); }

      // OSRM
      var coordsParam=ordered.map(function(p){return p.lon+','+p.lat}).join(';');
      var osrmUrl=CONFIG.workerBase+'/osrm?coords='+encodeURIComponent(coordsParam)+'&profile=driving&overview=full&geometries=geojson&steps=true';
      document.getElementById('stats2').textContent='Calcolo rotta (OSRM)...';
      var osrm; try{ osrm=await getJSON(osrmUrl); }catch(e){ toastCenter('Errore OSRM'); document.getElementById('stats2').textContent='Errore: OSRM'; return; }
      if(!osrm || osrm.code!=='Ok' || !osrm.routes || !osrm.routes[0]){ toastCenter('OSRM non ha restituito una rotta valida'); document.getElementById('stats2').textContent='Errore: OSRM'; return; }

      // Steps RTE (dedup su raw; poi override testa/coda con i waypoint geocodificati)
      var rte=[];
      var legs=(osrm.routes[0].legs||[]);
      for(var li=0; li<legs.length; li++){
        var steps=(legs[li].steps||[]);
        for(var si=0; si<steps.length; si++){
          var step=steps[si];
          if(step.maneuver && Array.isArray(step.maneuver.location)){
            var lonRaw=Number(step.maneuver.location[0]), latRaw=Number(step.maneuver.location[1]);
            if(rte.length){
              var last=rte[rte.length-1];
              if(Math.abs(Number(last._latRaw)-latRaw)<1e-7 && Math.abs(Number(last._lonRaw)-lonRaw)<1e-7) continue;
            }
            rte.push({
              _latRaw: latRaw,
              _lonRaw: lonRaw,
              lat: roundHalfEvenToFixed(latRaw,6),
              lon: roundHalfEvenToFixed(lonRaw,6),
              type: String(step.maneuver.type||'')
            });
          }
        }
      }
      // >>> Allineamento PowerShell: forza primo/ultimo RTE = waypoint input (arrotondati a 6)
      if(rte.length){
        rte[0].lat  = roundHalfEvenToFixed(Number(ordered[0].lat), 6);
        rte[0].lon  = roundHalfEvenToFixed(Number(ordered[0].lon), 6);
        rte[rte.length-1].lat = roundHalfEvenToFixed(Number(ordered[ordered.length-1].lat), 6);
        rte[rte.length-1].lon = roundHalfEvenToFixed(Number(ordered[ordered.length-1].lon), 6);
      }

      // TRK: idem, testa/coda = waypoint input
      var trk=(osrm.routes[0].geometry && osrm.routes[0].geometry.coordinates)?osrm.routes[0].geometry.coordinates:[];
      if(trk.length){
        trk[0] = [ Number(ordered[0].lon), Number(ordered[0].lat) ];
        trk[trk.length-1] = [ Number(ordered[ordered.length-1].lon), Number(ordered[ordered.length-1].lat) ];
      }

      var startLabel=fileNameSafe(await reverseShortLabel(ordered[0].lat,ordered[0].lon));
      var endLabel=fileNameSafe(await reverseShortLabel(ordered[ordered.length-1].lat,ordered[ordered.length-1].lon));
      var title='GPX da: '+startLabel+' a: '+endLabel;
      var ts=nowStamp();

      gpxRTE=buildGPX_RTE_WPT(ordered,rte,title);
      gpxTRK=buildGPX_TRK_WPT(ordered,trk,title);
      nameRTE='maps2gpx_osrm_rotta_'+startLabel+'_'+endLabel+'_'+ts+'.gpx';
      nameTRK='maps2gpx_osrm_traccia_'+startLabel+'_'+endLabel+'_'+ts+'.gpx';

      document.getElementById('stats2').textContent=ordered.length+' punti convertiti (WPT) · RTE '+rte.length+' step · TRK '+trk.length+' vertici';

      var prevR=gpxRTE.split('\n').slice(0,200).join('\n'); document.getElementById('gpxPreviewRte').textContent=prevR+(gpxRTE.length>prevR.length?'\n...':''); document.getElementById('previewWrapRte').hidden=false;
      var prevT=gpxTRK.split('\n').slice(0,200).join('\n'); document.getElementById('gpxPreviewTrk').textContent=prevT+(gpxTRK.length>prevT.length?'\n...':''); document.getElementById('previewWrapTrk').hidden=false;
      document.getElementById('dlRow').style.display='';
      toastCenter('GPX RTE & TRK pronti');
    });

    function downloadBlob(name, content, mime){
      var bytes=new TextEncoder().encode(content); // mantiene newline finale
      var url=URL.createObjectURL(new Blob([bytes],{type:mime||'application/gpx+xml'}));
      var a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    document.getElementById('btnDownloadRTE').addEventListener('click',async function(){ if(!gpxRTE){toastCenter('Nessun GPX RTE');return} var ok=await confirmAction('Scaricare il file GPX della rotta (WPT+RTE)?'); if(!ok)return; downloadBlob(nameRTE||('maps2gpx_rotta_'+nowStamp()+'.gpx'),gpxRTE,'application/gpx+xml'); toast('Download avviato'); });
    document.getElementById('btnDownloadTRK').addEventListener('click',async function(){ if(!gpxTRK){toastCenter('Nessun GPX TRK');return} var ok=await confirmAction('Scaricare il file GPX della traccia (WPT+TRK)?'); if(!ok)return; downloadBlob(nameTRK||('maps2gpx_traccia_'+nowStamp()+'.gpx'),gpxTRK,'application/gpx+xml'); toast('Download avviato'); });
    document.getElementById('btnClear2').addEventListener('click',function(){ document.getElementById('maps2gpxInput').value=''; resetMaps2GPXUI(); document.getElementById('stats2').textContent='Pulito.'; });
  </script>
</body>
</html>
